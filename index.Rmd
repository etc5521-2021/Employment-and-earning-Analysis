---
title: "ETC5521 Assignment 2"
subtitle: "Employment and Earnings"
team: Cassowary
author:
  - Sahinya Akila
  - Xinrui Wang
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
    fig_caption: yes
---

[This assignment is for ETC5521 Assignment 2 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
```

```{r}
library(tidyr)
library(tibble)
library(dplyr)
library(ggplot2)
library(ggstream)
library(gganimate)
library(plotly)
library(kableExtra)
library(tidyverse)
library(hrbrthemes)
library(plotly)
library(magick)
library(ggResidpanel)
library(broom)
library(colorspace)
```


```{r}
employed <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-23/employed.csv')

earn <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-23/earn.csv')
```



# Introduction and Motivation - Rachel to edit

Employment and earning is one of the most frequently discussed topics of all time, gender and race are often brought up in terms of fairness in workplace. Fekedulegn et al. (2019) suggested that workplace discrimination and mistreatment varied significantly by race and gender in the US, this statement raises the interest on exploring and conducting a detailed analysis in regards to the employment and earnings across different industries in the USA, and to find out if this statement is true and how significant gender and race are affecting employment and earning.

The data used in this report is collected from [tidytuesday](https://github.com/rfordatascience/tidytuesday/blob/master/data/2021/2021-02-23/readme.md), by looking through the employment status and earning from 2010 to 2020 across different races, genders as well as age groups in various industries in the US, the findings will assist with promoting fairness, equality and diversity in the workplace.

Analysis conducted and conclusions drew in this report are solely based on the datasets described under Data Description section, all records in the datasets are assumed to be accurate. Furthermore, due to the inadequate information in regions and inconsistency of time frame in the two datasets used in this report, the findings could be subject to potential bias.

# Data Description - Sahinya to edit

The datasets originally come from [BLS](https://www.bls.gov/cps/tables.htm#charemp_m), specifically table *cpsaat17* across several years.  

The **employed** dataset tells about employed persons by industry, sex, race, and occupation through 2015 to 2020.

```{r}
employtable <- data_frame(Column_name = colnames(employed), 
                          data_type = sapply(employed, typeof),
                          description = c("Industry Group", "Major occupation category", "Minor occupation category", "Race & Gender wise information", "Industry total count", "Number of people employed", "Year")) 
kable(employtable,
      col.names = c("Variable", "Data Type", "Description"),
      align = "l") %>%
  kable_styling("striped", position = 'center')
```

The **earn** dataset tells about weekly median earnings and number of persons employed by race/gender/age group through 2010 to 2020.

```{r}
earntable <-data_frame(Column_name = colnames(earn), 
                          data_type = sapply(earn, typeof),
                          description = c("Gender", "Racial group", "Ethnic origin (hispanic or non-hispanic)", "Age group", "Year", "Quarter", "Number of persons employed by group", "Median weekly earning in current dollars")) 
kable(earntable,
      col.names = c("Variable", "Data Type", "Description"),
      align = "l") %>%
  kable_styling("striped", position = 'center')
```

The datasets are collected from the Current Population Survey (CPS) which is a monthly survey of households conducted by the Bureau of Census for the Bureau of Labor Statistics.

Here are some findings when looking through the methods used to tidy and wrangle data from the original source:  

- employed data   
The raw data is in excel format. The author of tidytuesday firstly took one year in the data as an example to clean, using `slice()`, `rename()` etc functions to display the titles and data itself of the original table clearly and properly. Then, in order to have each variable corresponding to one column, `pivot_longer()` was used. After that, the author got rid of those redundant characters by `regexp` and selected the required data. With these steps, it is about to finish cleaning the data for a given year. What to do next is to create a function referring to the steps above and apply the function to combine all years. Yet, it's necessary to have the tidy data checked by simply making a plot using `ggplot2` function. Finally, the data can be output by `write_csv()`.  

- earn data  
The raw data is in excel format. The author changed it to a table format using `html_nodes()` and `html_table()`. Similarly as in the employed data, a function was created and data was combined together with the functions `bind_rows()` and `left_join()`. Then, with similar steps,the final cleaned data can be acquired through basic tidy methods like `filter()`, `select()`, `mutate()` etc. Last but not the least, the data can be checked and output.


Based on the datasets, five questions are going to be explored and analyzed in the following section, including:

- What are the changes of people employed in different industries from 2015 to 2020?
 
- What are the demographic differences between industries from 2015 to 2020?

- At what age do men and women work the most and how does the age factor contribute towards employement?

- How do different factors affect the income between 2010 and 2020?

- How significant is gender and race in affecting earnings?
  

# Analysis and Findings

## What are the changes of people employed in different industries from 2015 to 2020? - Sahinya to edit

```{r fig1, message=FALSE, warning=FALSE, fig.width=10, fig.height=8, fig.align='center', fig.cap="Number of people employed across industry from 2015 to 2020"}

options(scipen=1000)
industry <- employed %>%
  filter(race_gender == 'TOTAL',
         !is.na(industry),
         !is.na(industry_total)) %>%
  select(industry, industry_total,year) %>%
  rename("Number of people employed" = `industry_total`) %>%
  group_by(year) %>%
  unique() %>%
  arrange(industry) %>%
  mutate(industry = factor(industry, industry), text = paste0("Year: ", year, "\n", "Industry: ", industry, "\n", "Total Employed: ", `Number of people employed`))

ggplot(industry, aes(year, industry, fill= `Number of people employed`, text = text)) + 
  geom_tile(size=1, colour = "white") +
  theme_ipsum()

```

First of all, Figure \@ref(fig:fig1) shown above indicates the changes of all the population of employees from different industries in recent 5 years. To be more specific, there is a large number of people working in the industry of education and health services, and the population stayed stably between 34 million and 35 million during 2015 to 2020. However, as the industry of private households hold the least population, the number of people employed in this industry actually decreased from around 0.7 million to 0.6 million. In addition, all industries experienced the decrease of people employed within the industries from 2019 to 2020 except for the public administration. 


## What are the demographic differences between industries from 2015 to 2020? - Sahinya to edit

### Gender

```{r fig2, fig.width=10, fig.height=8, fig.align='center', fig.cap="Distribution of men and women across industries"}
Gender <- employed %>%
  filter(race_gender %in% c('Men','Women'),
         !is.na(industry),
         !is.na(industry_total)) %>%
  select(industry, race_gender,industry_total,year) %>%
  rename(Gender = race_gender) %>%
  unique() %>% 
  arrange(year, industry, Gender)

p <- Gender %>% ggplot(aes(x = industry, y = industry_total, fill = industry)) +
  geom_col() +
  theme_bw() +
  labs(x = "",
       y = "") +
  theme(axis.text.x = element_text(angle = 90), legend.position="none") +
  facet_grid(year ~ Gender)

plotly::ggplotly(p)

```

In the analysis about genders in different industries, it is found that there are only five industries that have more female employees than male, which are education and health services, financial activities, leisure and hospitality, other services and private households (Figure \@ref(fig:fig2)). Especially in the industry of education and services, the number of female employees is more than twice as much as the number of male employees. On the contrary, male workers occupy most of the roles in some industries like manufacturing, construction, transportation and utilities and durable goods. More than 90% of the employees are male in the industry of construction.


### Race

```{r fig3, fig.width=12, fig.height=8, fig.align='left', fig.cap="Distribution of different races across industries"}
Race <- employed %>%
  filter(race_gender %in% c('White','Black or African American', 'Asian'),
         !is.na(industry),
         !is.na(industry_total)) %>%
  select(industry, race_gender,industry_total,year)%>%
  rename(Race = race_gender) %>%
  unique()%>% 
  arrange(year, industry, Race)

p <- Race %>% ggplot(aes(x = industry, y = industry_total, fill = industry)) +
  geom_col() +
  theme_bw() + 
  labs(x = "",
       y = "") +
  theme(axis.text.x = element_text(angle = 90), legend.position="none") +
  facet_grid(year ~ Race)

plotly::ggplotly(p)

```

According to Figure \@ref(fig:fig3), when looking at the relationships between industries and the population employed among races from the data, most of the people employed among all the industries are white people, following by Black or African American and Asian. 

## At what age do men and women work the most and how does the age factor contribute towards employement? - Sahinya

```{r fig4, fig.cap="Employment rate by gender and age group"}
total <- sum(earn$n_persons)
earn %>% 
  filter(sex %in% c("Men", "Women")) %>% 
  group_by(sex, age) %>% 
  summarise(percent = 100 * sum(n_persons)/total) %>% 
  ggplot(aes(x = age, y = percent, fill = sex)) + 
  geom_col(position = "dodge") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90))
```

It can be observed from Figure \@ref(fig:fig4) that both men and women in between the age 16 to 54 have been employed more when compared to other age groups. It is also evident that the number of male employees are more when compared to women. There is a peak in 25-54 age group as this is the age when people finish education and start their career. This also happens to be the prime working time in most of their lives. As one intends the curve to be, there is a peak and the 25-54 age group and the numbers slowly go down after 55 years as people start their retirement phase.  

## How do different factors affect the income between 2010 and 2020? - Rachel to edit

```{r}
earn <- earn %>% 
  mutate(year = as.factor(year),
         quarter = as.factor(quarter))
earn_all <- earn %>% 
  filter(sex == "Both Sexes",
         race == "All Races",
         ethnic_origin == "All Origins",
         age == "16 years and over")
```

When taking a look at the earning data, median weekly income varies through different genders, races and age groups.

### Gender & Race

```{r fig5, fig.align = 'center', fig.cap="Race and gender do play significant role in income"}
earn %>%
  filter(sex != "Both Sexes",
         race != "All Races",
         ethnic_origin == "All Origins",
         age == "16 years and over") %>%
  group_by(year, sex, race) %>%
  summarise(median_weekly_earn = mean(median_weekly_earn)) %>%
  pivot_wider(id_cols = c(race, year),
              names_from = sex,
              values_from = median_weekly_earn) %>%
  ggplot() +
  geom_segment(aes(x = year, xend = year, y = Men, yend = Women, colour = race)) +
  geom_point(aes(x = year, y = Men, colour = race)) + 
  geom_point(aes(x = year, y = Women, colour = race)) +
  annotate("text", x = 3, y = 1400, color = "black", label = "Upper Vertex: Men") +
  annotate("text", x = 3, y = 1280, color = "black", label = "Lower Vertex: Women") +
  ylab("Median Weekly Earn") +
  xlab("Year") +
  theme_bw() +
  scale_colour_manual(values=c("#00b0f6","#71CA97", "#ff7f7f"))

```

Figure \@ref(fig:fig5) indicates that gender and race do play significant role in affecting weekly income through the past ten years. A clear upward trend in income can be observed in general over the period, the upper vertex of the segments represents male's income and the lower one represents female's, which clearly shows that men generally earn more than women in all years and races from 2010 to 2020. In addition, the plot suggests that race is also a key factor affecting income. **A surprising finding is that while the number of Asians employed are very low across all industries, Asians actually have the highest median weekly income among the three races recorded,** followed by the white race while the black or African American earns the least. This may reflect differences in the amount of time and energy that people of different races are willing to devote to their jobs, Asians are well-known for hard working and are more likely to work extra hours compare with the other two races. On the other hand, another possible reason is that there is a common belief that Asians are smart and tend to be educated for high-income occupations such as doctors and lawyers, while Black and African Americans may suffer from racial discrimination and are forced to work in low-income jobs.

### Age group

```{r fig6, fig.align = 'center', fig.cap="Median weekly income by year and age group"}
plot_theme <- theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed", color = "darkgrey"),
    panel.grid.minor.y = element_blank(),
    axis.text.x = element_blank()
  )

earn %>%
  filter(age %in% c("16 to 24 years", "25 to 34 years", "35 to 44 years", "45 to 54 years", "55 years and over"),
         sex == "Both Sexes",
         race == "All Races",
         ethnic_origin == "All Origins") %>%
  group_by(year, age) %>% 
  summarise(mean = mean(median_weekly_earn)) %>%
  ggplot(aes(x = age, y = mean)) +
  geom_col(aes(fill = age) ,position = "dodge", size = 1) +
  geom_text(aes(label = round(mean, 1))) +
  xlab("Year") +
  ylab("Mean of median weekly earn") +
  scale_fill_brewer(palette = 1) +
  scale_y_continuous(breaks = c(fivenum(earn$median_weekly_earn))) +
  plot_theme +
  labs(title = 'Median Weekly Earn per Year: {closest_state}', subtitle = "Across different Age Groups") +
  transition_states(year)
```

Based on Figure \@ref(fig:fig6), income levels at different age groups are all growing over the years. The Y-axis is divided by the minimum, 1/4 quantile, median, 3/4 quantile and maximum income of the total median weekly income. The plot interactively demonstrates that young adults earn much less than middle-aged people and there's not much difference between age groups over 35. The finding is reasonable based on common sense, where people at age of 16-24 are most likely school leavers and full-time students who are working part-time, the income for this group are lower considering the number of hours they can work each week and the skill level of the occupations/positions they can get. 25-34 years old on the other hand, are more likely in the earlier stage of their career and working in entry level positions, the wages for these positions are generally higher but still not as high as senior positions, where majority of the age group 35 and over are working in.


## How significant are gender and race affecting earnings?

Based on the findings above, it is clear that the median weekly income varies across gender and race, this section focus on exploring how significant each of them is in affecting earnings, and which one of them plays the most important role in median weekly income in the US.

```{r}
reg <- earn %>% 
  select(sex,
         race,
         year,
         median_weekly_earn) %>% 
  filter(!sex == "Both Sexes",
         !race == "All Races") %>% 
  mutate(year = as.character(year))
```


```{r fig7, fig.cap="Distribution of median weekly income by gender and race"}
ggplot(reg, aes(race, median_weekly_earn)) + 
  geom_violin(aes(fill = sex),
              draw_quantiles = c(0.25, 0.5, 0.75)) +
  geom_boxplot(width = 0.15) +
  labs(x = "Race", 
       y = "Meidan Weekly Income",
       fill = "Gender") +
  theme_bw() +
  scale_fill_discrete_qualitative()
```
Figure \@ref(fig:fig7) compares the distribution of median weekly income of male and female together with the overall distribution (the boxes without colour), it is obvious that women has lower median weekly income than not only male, but also the overall level in all three races. In addition, it confirms the previous findings that Asian has the highest median weekly income whereas the lowest is observed in Black or African American. Furthermore, the spread of distribution is wider for male compare with female, which suggests the differences between high and low median weekly income is larger among men. The findings again, confirmed that both gender and race are significant factors in terms of earning, however, it is hard to suggest how much they are affecting the median weekly income, or which one is more significant than the other.

A model is then introduced, however, before fitting a model to the data, an important factor to be considered is that **the earning data is time series data**, median weekly income naturally grows across all variables of interests over the years, assumption of independence and randomness is violated in this case. The best possible solution under this circumstances is to consider year as an additional categorical variable and include it in the model.

```{r reg}
model <- lm(median_weekly_earn ~ sex + race + year,
            data = reg)

summary(model) %>% 
  tidy()%>%
  kable(align = "c",
        digits = 4,
        caption = "Regression model fitted to median weekly income by gener, race and year") %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "300px")
```

A linear regression model is then fitted as shown in Table \@ref(tab:reg), **the p values for Women, Black or African American and White are all extremely close to 0, indicates that they are significant in this model**. The estimates of coefficients of years are all positive and gradually increasing from 2010 to 2020, which align with the previous findings that median weekly income increase over years overall. The fitted model can be written as per below:

$$MedianWeeklyEarn = 909.3758 - 150.8788*Women - 278.7114*BlackorAfricanAmerican - 110.8727*White +...+271.833*Year2020$$

According to the model, the median weekly income of women in general is 150.8788 dollars lower than women, whereas the median weekly income of Black or African American and White are 278.7114 and 110.8727 dollars lower compare with Asian respectively. Therefore, among all the variables of interest, **Black or African American in race has the most impact on median weekly income, followed by women and White in race.**

Regression diagnostics for the model are also conducted to examine the goodness of fit, overall, the fitted model can explain part of the variations within the data, but there is room for improvements by introducing additional datasets and potentially more variables. 

```{r fig8, fig.cap="Diagnostics for the fitted model"}
resid_panel(model, plots = "SAS")
```

Discreteness can be clearly observed from the residual plot in Figure \@ref(fig:fig8), it is mainly caused by the nature of the independent variables used in the model, all independent variables are categorical i.e. discrete in the model, hence the discreteness in residual plot is not surprising. In addition, both R squared and adjusted R squared for the fitted model is smaller than 0.5 as shown in Table \@ref(tab:fit), it suggests that only about 46% of the variation observed from the data is explained by the fitted model.

```{r fit}
glance(model)%>% 
  select(r.squared,adj.r.squared, AIC, BIC) %>% 
  kable(align = "c",
        digits = 4,
        caption = "Goodness of fit") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Based on the findings above, race, specifically Black or African American has significant impact on median weekly earnings in the US from 2010 to 2020, followed by gender and White, however, the model could be improved by adding more datasets and new variables such as industry, education level etc., and the findings may subject to change if new model is fitted.


# Key Findings and Limitations - Rachel to edit

Industries that generally require more physical labor and technical skills are overwhelmingly dominated by male, whereas industries with more women generally require more patience and carefulness. In terms of earnings, men generally earn more than women, and younger age groups also turns to earn less compare with those who are 35 years old and over. An interesting findings is discovered in exploring the race factor, although Asians occupy a very low proportion in number of people employed, they have higher median weekly income than White people, which have significantly higher number of people employed across industries. Black or African Americans are earning the least and with very low number of people employed across industries. The regression model also supports these findings and demonstrates that Black or African American is the most significant variable result in earning lower median weekly income, followed by being a women and White. Based on the findings, it is proved that gender and race do play significant role in both employment and earning across industries in the US, discrimination and mistreatment in the workforce could be an concerning issue in the US.

In terms of limitations, the period of records in the two datasets used are different, employment dataset is recorded from 2015 to 2020 whereas earning contains data from 2010 to 2020, the inadequateness could lead to biased findings and conclusions. Age group and ethnic origins could also be considered with additional datasets from different data sources with a longer time line in future studies, in order to draw more precise conclusions.


# References

Fekedulegn.D, Alterman.T, Charles.L, Kershaw.K, Safford.M, Howard.V, MacDonald.L (2019).Prevalence of workplace discrimination and mistreatment in a national sample of older U.S. workers: The REGARDS cohort study, *SSM - Population Health,* Volume 8, 100444, ISSN 2352-8273, https://doi.org/10.1016/j.ssmph.2019.100444.

## Data source

Labor Force Statistics from the Current Population Survey. (2021). Retrieved 15 August 2021, from https://www.bls.gov/cps/tables.htm#charemp_m

Tidytuesday. (2021). Retrieved 15 August 2021, from https://github.com/rfordatascience/tidytuesday/blob/master/data/2021/2021-02-23/readme.md


## Software

R Core Team (2020). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.


## Packages

David Robinson, Alex Hayes and Simon Couch (2021). broom: Convert Statistical Objects into Tidy Tibbles. R package version 0.7.9. https://CRAN.R-project.org/package=broom

Hadley Wickham, Romain François, Lionel Henry and Kirill Müller (2021). dplyr: A Grammar of Data Manipulation. R package version 1.0.5. https://CRAN.R-project.org/package=dplyr

Hadley Wickham (2021). tidyr: Tidy Messy Data. R package version 1.1.3.https://CRAN.R-project.org/package=tidyr

Hao Zhu (2021). kableExtra: Construct Complex Table with 'kable' and Pipe Syntax. R package version 1.3.4. https://CRAN.R-project.org/package=kableExtra

Jeroen Ooms (2021). magick: Advanced Graphics and Image-Processing in R. R package version 2.7.3. https://CRAN.R-project.org/package=magick

JJ Allaire and Yihui Xie and Jonathan McPherson and Javier Luraschi and Kevin Ushey and Aron Atkins and Hadley Wickham and Joe Cheng and Winston Chang and Richard Iannone (2021). rmarkdown: Dynamic Documents for R. R package version 2.10. URL https://rmarkdown.rstudio.com.

Katherine Goode and Kathleen Rey (2019). ggResidpanel: Panels and Interactive Versions of Diagnostic Plots using 'ggplot2'. R package version 0.3.0. https://CRAN.R-project.org/package=ggResidpanel
  
Kirill Müller and Hadley Wickham (2021). tibble: Simple Data Frames. R package version 3.1.3. https://CRAN.R-project.org/package=tibble

Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686

Wilke, C.O. (2020). ggtext: Improved Text Rendering Support for 'ggplot2'. R package version 0.1.1. https://CRAN.R-project.org/package=ggtext

Yihui Xie and J.J. Allaire and Garrett Grolemund (2018). R Markdown: The Definitive Guide. Chapman and Hall/CRC. ISBN 9781138359338. URL https://bookdown.org/yihui/rmarkdown.

Yihui Xie and Christophe Dervieux and Emily Riederer (2020). R Markdown Cookbook. Chapman and Hall/CRC. ISBN 9780367563837. URL https://bookdown.org/yihui/rmarkdown-cookbook.

Zeileis A, Hornik K, Murrell P (2009). “Escaping RGBland: Selecting Colors for Statistical Graphics.” Computational Statistics \& Data Analysis, *53*(9), 3259-3270. doi: 10.1016/j.csda.2008.11.033 (URL: https://doi.org/10.1016/j.csda.2008.11.033)
